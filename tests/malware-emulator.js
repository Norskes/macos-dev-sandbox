const fs = require("fs").promises;
const path = require("path");
const os = require("os");

const HOME = os.homedir();
const SANDBOX_DIR = process.env.SANDBOX_BASE_DIR || path.join(HOME, "Sandbox");

// Ð¦Ð²ÐµÑ‚Ð½Ð¾Ð¹ Ð²Ñ‹Ð²Ð¾Ð´
const colors = {
  red: "\x1b[31m",
  green: "\x1b[32m",
  yellow: "\x1b[33m",
  blue: "\x1b[34m",
  reset: "\x1b[0m",
};

// Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
const log = {
  info: (msg) => console.log(`${colors.blue}â„¹ï¸  ${msg}${colors.reset}`),
  success: (msg) => console.log(`${colors.green}âœ… ${msg}${colors.reset}`),
  warning: (msg) => console.log(`${colors.yellow}âš ï¸  ${msg}${colors.reset}`),
  error: (msg) => console.log(`${colors.red}âŒ ${msg}${colors.reset}`),
  file: (path) => console.log(`\nðŸ“„ Trying to read: ${path}`),
};

// Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
const TEST_CASES = {
  // ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ (Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹)
  blocked: [
    // SSH
    "~/.ssh/config",
    "~/.ssh/id_rsa",
    // Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€
    "~/Library/Application Support/Google/Chrome/Default/Cookies",
    "~/Library/Application Support/Google/Chrome/Default/History",
    "~/Library/Application Support/Firefox/Profiles/*/cookies.sqlite",
    "~/Library/Application Support/Firefox/Profiles/*/places.sqlite",
    // Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹
    "~/Documents/passwords.txt",
    "~/Documents/private",
    // Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
    "/etc/passwd",
    "/etc/shadow",
    // ÐžÐ±Ð»Ð°Ñ‡Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
    "~/.aws/credentials",
    "~/.aws/config",
    "~/.config/gcloud/credentials",
    "~/.config/gcloud/legacy_credentials",
    // ÐšÐ¾Ð½Ñ„Ð¸Ð³Ð¸ Ð¸ ÐºÐ»ÑŽÑ‡Ð¸
    "~/.config/some_app/secrets",
    "~/.npmrc",
    "~/.gitconfig",
    "~/.docker/config.json",
    "~/.kube/config",
    // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸
    "~/Downloads/secret.pdf",
    // Keychain Ð¸ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹
    "~/Library/Keychains/*",
    "~/Library/Application Support/com.apple.TCC/TCC.db",
    // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
    "~/Pictures",
    "~/Movies",
    "~/Music",
    "~/Desktop",
  ],

  // Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ (Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹)
  allowed: [
    // ÐŸÐµÑÐ¾Ñ‡Ð½Ð¸Ñ†Ð°
    "$SANDBOX/test.txt",
    "$SANDBOX/project/src/index.js",
    "$SANDBOX/.git/config",
    "$SANDBOX/node_modules/package.json",
    // ÐšÐµÑˆ
    "~/Library/Caches/test.cache",
    "~/Library/Caches/npm/package.json",
    "~/Library/Caches/yarn",
    "~/Library/Caches/pip",
    // Ð›Ð¾Ð³Ð¸
    "~/Library/Logs/test.log",
    "~/Library/Logs/sandbox.log",
    // Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
    "/private/tmp/test.tmp",
    "/private/var/folders/test.tmp",
    "/private/var/folders/*/T/*",
    // ÐŸÐ°ÐºÐµÑ‚Ð½Ñ‹Ðµ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ñ‹
    "~/.npm/test-package",
    "~/.yarn/cache/test",
    "~/.pnpm-store/test",
    "~/.cache/test",
    // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð½Ñ‹Ðµ Ð¿ÑƒÑ‚Ð¸
    "$SANDBOX/tests/*",
    "$SANDBOX/build/*",
    "$SANDBOX/dist/*",
  ],

  // Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ (Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ)
  readonly: [
    // Node.js Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸
    "/usr/local/bin/node",
    "/usr/lib/system/libsystem_kernel.dylib",
    "/System/Library/Frameworks/CoreFoundation.framework/CoreFoundation",
    // OpenSSL Ð¸ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹
    "/System/Library/OpenSSL/openssl.cnf",
    "/etc/ssl/openssl.cnf",
    "/System/Library/Security/Certificates.bundle",
    // Ð¡ÐµÑ‚ÐµÐ²Ñ‹Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð¸
    "/etc/hosts",
    "/etc/resolv.conf",
    "/private/etc/hosts",
    // Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ ÑƒÑ‚Ð¸Ð»Ð¸Ñ‚Ñ‹
    "/usr/bin/*",
    "/bin/*",
    "/usr/sbin/*",
    "/sbin/*",
    // Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ñ„Ñ€ÐµÐ¹Ð¼Ð²Ð¾Ñ€ÐºÐ¸
    "/System/Library/Frameworks/*",
    "/System/Library/PrivateFrameworks/*",
    // Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ñ
    "/System/Library/Extensions/*",
    "/Library/Extensions/*",
  ],
};

// Ð¤Ð°Ð¹Ð»Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¾ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ macOS sandbox Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ Ð¾Ñ‚ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ
const SYSTEM_BLOCKED_FILES = ["/etc/ssl/openssl.cnf", "/etc/resolv.conf"];

// Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð² Ð¿ÑƒÑ‚ÑÑ…
function resolvePath(filepath) {
  return filepath.replace("~", HOME).replace("$SANDBOX", SANDBOX_DIR);
}

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ñ„Ð°Ð¹Ð»Ñƒ
async function testFileAccess(filepath, mode = "read") {
  const resolvedPath = resolvePath(filepath);
  try {
    if (mode === "read") {
      await fs.access(resolvedPath, fs.constants.R_OK);
      // ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»
      await fs.readFile(resolvedPath).catch(() => {});
    } else if (mode === "write") {
      // ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
      const tempFile = resolvedPath + ".tmp";
      await fs.writeFile(tempFile, "test");
      await fs.unlink(tempFile);
    }
    return { success: true };
  } catch (error) {
    return {
      success: false,
      error: error.code === "ENOENT" ? "ENOENT" : "EPERM",
    };
  }
}

// Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð²
async function runTests() {
  log.info("Starting sandbox security tests...\n");

  // Ð¢ÐµÑÑ‚ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
  log.info("Testing blocked files (should be blocked)...");
  for (const file of TEST_CASES.blocked) {
    log.file(file);
    const result = await testFileAccess(file);
    if (!result.success) {
      log.success(
        `BLOCKED: ${
          result.error === "ENOENT"
            ? "ENOENT: no such file or directory"
            : "EPERM: operation not permitted"
        }, access '${resolvePath(file)}'`
      );
    } else {
      log.warning(`SUCCESS: File could be read!`);
    }
  }

  // Ð¢ÐµÑÑ‚ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
  log.info("\nTesting allowed files (should be accessible)...");
  for (const file of TEST_CASES.allowed) {
    log.file(file);
    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÑÐºÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
    const dir = path.dirname(resolvePath(file));
    await fs.mkdir(dir, { recursive: true }).catch(() => {});

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÑŒ (Ð³Ð»Ð°Ð²Ð½Ñ‹Ð¹ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°)
    const writeResult = await testFileAccess(file, "write");

    if (writeResult.success) {
      log.success(
        "ACCESS GRANTED: Write permission confirmed (file access allowed)"
      );
    } else {
      log.error(
        "ACCESS DENIED: Write operation failed - no access to directory"
      );
    }
  }

  // Ð¢ÐµÑÑ‚ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ
  log.info(
    "\nTesting read-only files (should be readable but not writable)..."
  );
  for (const file of TEST_CASES.readonly) {
    log.file(file);
    const readResult = await testFileAccess(file, "read");
    const writeResult = await testFileAccess(file, "write");
    const resolvedPath = resolvePath(file);

    if (readResult.success && !writeResult.success) {
      log.success("CORRECT: Read-only access confirmed");
    } else if (readResult.success && writeResult.success) {
      log.warning("WARNING: File is writable when it should be read-only");
    } else if (!readResult.success && readResult.error === "ENOENT") {
      log.success("CORRECT: File does not exist (normal for system files)");
    } else if (
      !readResult.success &&
      readResult.error === "EPERM" &&
      SYSTEM_BLOCKED_FILES.includes(resolvedPath)
    ) {
      log.success(
        "CORRECT: File is system-blocked by macOS sandbox (expected)"
      );
    } else {
      log.error("ERROR: File access blocked when it should be readable");
    }
  }
}

// Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ñ‹
runTests().catch((error) => {
  log.error("Test execution failed:");
  console.error(error);
  process.exit(1);
});
